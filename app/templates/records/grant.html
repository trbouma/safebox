{% extends "uxbase.html" %}

{% block title %}Update Record{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="/static/records-modern.css">

<script type="module">
  import * as pdfjsLib from "/js/pdf.mjs";

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "/js/pdf.worker.mjs";

  window.pdfjsLib = pdfjsLib;  // expose globally if needed
</script>

<script>
var global_card = "{{card}}";
var global_record_kind = parseInt("{{record_kind}}");
var referer = "{{referer}}";
console.log(referer)
async function backToProfile() {

window.location.href="/safebox/access" ;

}

async function goBack() {
    window.history.back();
}

async function privateData() {

window.location.href="/safebox/privatedata";
}

async function getStatus(return_result) {


parsedResult = JSON.parse(JSON.stringify(return_result));
alert(`${parsedResult.status} ${parsedResult.detail}`);

 

}

async function scanCode() {
// alert("scan!");

window.location.href="/scanner/scan";

}




async function updateOffer() {
    
    var data;
   
    var input_card_title = document.getElementById("input_card_title");
    var input_card_content = document.getElementById("input_card_content");

   
    // user_confirm = confirm(`Are you sure you want to proceed with updating ${input_card_title.value} ${record_kind}?`) ;
    // if (user_confirm == false) {return;}
    

    const submit_data = {"title": input_card_title.value,
                          "content": input_card_content.value,
                          "kind": global_record_kind,
                          "final_kind":global_record_kind };

    

   await fetch('/records/updaterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    
    // window.location.href=referer;
    // window.history.back();
    window.location.href="/records/offerlist?kind={{record_kind}}";
    // console.log(referer);
      }

async function deleteGrant() {
  

  user_confirm = confirm(`Are you sure you want to proceed with deleting {{ card }}?`) ;

  const submit_data = {"title": "{{ card }}", "kind": global_record_kind};

    

   await fetch('/records/deleterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    window.location.href=referer ;

}      



</script>

<script>

function consoleLog(data) {
    var logElement = document.getElementById('log');
    logElement.innerHTML += data + '\n';
  };

function renderPdfFallback(container, blobUrl, message = "PDF preview unavailable on this browser.") {
  if (!container) return;
  container.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.style.padding = "10px";
  wrap.style.border = "1px solid #3b5187";
  wrap.style.borderRadius = "12px";
  wrap.style.background = "#0d1430";
  wrap.style.textAlign = "center";

  const note = document.createElement("p");
  note.textContent = message;
  note.style.margin = "0 0 10px";
  note.style.color = "#cad9ff";
  wrap.appendChild(note);

  const link = document.createElement("a");
  link.href = blobUrl;
  link.target = "_blank";
  link.rel = "noopener noreferrer";
  link.textContent = "Open/Download Original PDF";
  link.style.display = "inline-block";
  link.style.padding = "10px 12px";
  link.style.border = "1px solid #5267ec";
  link.style.borderRadius = "10px";
  link.style.textDecoration = "none";
  link.style.color = "#eaf0ff";
  wrap.appendChild(link);

  container.appendChild(wrap);
}

async function getBlob() {

  const container = document.getElementById("media_container");
  const img = document.getElementById("dynamic_image");
  const recordStatus = document.getElementById("original_record_status");
  if (recordStatus) recordStatus.textContent = "Loading original record...";

  // Clear previous PDF render
  if (container) container.innerHTML = "";

  // Hide image initially
  if (img) {
    img.src = "";
    img.style.display = "none";
  }

  const blobUrl = `/records/blob?record_name=${encodeURIComponent(global_card)}&record_kind=${global_record_kind}`;

  try {
    const res = await fetch(blobUrl);

    // ðŸš« If not found â†’ show nothing
    if (!res.ok) {
      if (recordStatus) recordStatus.textContent = "Original Record";
      return;
    }

    const mimeType = (res.headers.get("Content-Type") || "")
                        .split(";")[0]
                        .trim()
                        .toLowerCase();

    // ðŸ–¼ IMAGE HANDLING (use existing img tag)
    if (mimeType.startsWith("image/") && img) {

      img.src = blobUrl;
      img.style.width = "90%";      // 90% width
      img.style.height = "auto";
      img.style.display = "block";
      if (recordStatus) recordStatus.textContent = "Original Record";

      return;
    }

    // ðŸ“„ PDF HANDLING (PDF.js)
    if (mimeType === "application/pdf" && container) {
      if (!window.pdfjsLib || typeof window.pdfjsLib.getDocument !== "function") {
        renderPdfFallback(container, blobUrl);
        if (recordStatus) recordStatus.textContent = "Original Record";
        return;
      }

      const loadingTask = pdfjsLib.getDocument({
        url: blobUrl,
        standardFontDataUrl: "/js/standard_fonts/"
        });

      const pdf = await loadingTask.promise;
      let currentPage = 1;
      const totalPages = pdf.numPages;

      const controls = document.createElement("div");
      controls.style.display = "flex";
      controls.style.flexDirection = "column";
      controls.style.alignItems = "center";
      controls.style.justifyContent = "center";
      controls.style.gap = "6px";
      controls.style.margin = "8px 0 10px";

      const navRow = document.createElement("div");
      navRow.style.display = "flex";
      navRow.style.alignItems = "center";
      navRow.style.justifyContent = "center";
      navRow.style.gap = "10px";
      navRow.style.flexWrap = "nowrap";
      navRow.style.width = "100%";

      const prevBtn = document.createElement("button");
      prevBtn.type = "button";
      prevBtn.textContent = "Prev";
      prevBtn.style.width = "88px";
      prevBtn.style.minWidth = "88px";
      prevBtn.style.padding = "8px 10px";
      prevBtn.style.margin = "0";

      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.textContent = "Next";
      nextBtn.style.width = "88px";
      nextBtn.style.minWidth = "88px";
      nextBtn.style.padding = "8px 10px";
      nextBtn.style.margin = "0";

      const pageLabel = document.createElement("span");
      pageLabel.style.fontSize = "0.9rem";
      pageLabel.style.color = "#cfd8ff";

      navRow.appendChild(prevBtn);
      navRow.appendChild(nextBtn);
      controls.appendChild(navRow);
      controls.appendChild(pageLabel);
      container.appendChild(controls);

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.style.display = "block";
      canvas.style.width = "100%";
      canvas.style.maxWidth = "100%";
      canvas.style.height = "auto";
      canvas.style.boxSizing = "border-box";
      canvas.style.marginBottom = "12px";
      container.appendChild(canvas);

      async function renderPage(pageNum) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1 });
        const hostWidth = Math.max(280, (container.clientWidth || viewport.width) - 4);
        const scale = hostWidth / viewport.width;
        const scaledViewport = page.getViewport({ scale: scale });

        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;
        pageLabel.textContent = `${pageNum}/${totalPages}`;
        prevBtn.disabled = pageNum <= 1;
        nextBtn.disabled = pageNum >= totalPages;

        await page.render({
          canvasContext: context,
          viewport: scaledViewport
        }).promise;
      }

      prevBtn.addEventListener("click", async () => {
        if (currentPage > 1) {
          currentPage -= 1;
          await renderPage(currentPage);
        }
      });

      nextBtn.addEventListener("click", async () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          await renderPage(currentPage);
        }
      });

      await renderPage(currentPage);
      if (recordStatus) recordStatus.textContent = "Original Record";

      return;
    }

    // Anything else â†’ do nothing

  } catch (err) {
    console.log("Render error:", err);
    if (container) renderPdfFallback(container, blobUrl);
    if (recordStatus) recordStatus.textContent = "Original Record";
  }
}

function mimeTypeToExtension(mimeType) {
  const map = {
    "application/pdf": "pdf",
    "image/jpeg": "jpg",
    "image/jpg": "jpg",
    "image/png": "png",
    "image/gif": "gif",
    "image/webp": "webp",
    "image/svg+xml": "svg",
    "text/plain": "txt",
    "application/json": "json",
    "application/xml": "xml",
    "text/xml": "xml"
  };
  return map[mimeType] || "bin";
}

function slugifyGrantName(name) {
  const cleaned = String(name || "grant")
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^A-Za-z0-9._-]/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "");
  return cleaned || "grant";
}

async function exportGrantBlob() {
  const blobUrl = `/records/blob?record_name=${encodeURIComponent(global_card)}&record_kind=${global_record_kind}`;
  try {
    const res = await fetch(blobUrl);
    if (!res.ok) {
      alert("No original record blob found to export.");
      return;
    }

    const mimeType = (res.headers.get("Content-Type") || "application/octet-stream")
      .split(";")[0]
      .trim()
      .toLowerCase();
    const extension = mimeTypeToExtension(mimeType);
    const grantTitle = "{{ card.split(':')[1] if ':' in card else card }}";
    const filename = `${slugifyGrantName(grantTitle)}.${extension}`;

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement("a");
    anchor.href = url;
    anchor.download = filename;
    document.body.appendChild(anchor);
    anchor.click();
    anchor.remove();
    URL.revokeObjectURL(url);
  } catch (error) {
    consoleLog(`Export error: ${error}`);
    alert("Unable to export original record.");
  }
}

// getBlob();
document.addEventListener("DOMContentLoaded", () => getBlob());
</script>

{% endblock %}

{% block page_content %}



<div class="center-text">
    <h1> {{grant_label}}  Record</h1>  
    <div class="card">
      <div class="card-title">{{ card.split(':')[1] if ':' in card else card }}</div>
      <div class="card-content">{{ content }}</div>

    </div>
    <br><br>
    <button onclick="goBack()">Back</button>
   <div class="original-record-panel">
      <br><span id="original_record_status">Original Record</span><hr>
      <img id="dynamic_image" alt="" style="display: block; margin: 0 auto;" />
      <br>
      <iframe id="pdf_viewer" style="display:none; width:100%; height:600px; border:1px solid #ccc;"></iframe>
      <div id="media_container" style="width:100%; max-width:900px; margin:0 auto;"></div>
      <button type="button" onclick="exportGrantBlob()">Export Original</button>
      <hr>
    </div>
    <br>
    <button onclick="deleteGrant()">Delete</button>

    <br><br>
    <button onclick="backToProfile()">Home</button>
    
</div>



   

<div class="center-text">    
    <hr>
    {{action_mode}} {{record_kind}}  {{referer}} grant.html   
</div>
<div class="center-text">    
 
    <hr>
    <pre id="log"></pre>  
</div>

     
<script>
  setDarkMode();
</script>


{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}
