{% extends "uxbase.html" %}

{% block title %}Update Record{% endblock %}
{% block head %}
{{ super() }}



<script>
var global_card = "{{card}}";
var global_record_kind = parseInt("{{record_kind}}");
var referer = "{{referer}}";
console.log(referer)
async function backToProfile() {

window.location.href="/safebox/access" ;

}

async function goBack() {
    window.history.back();
}

async function privateData() {

window.location.href="/safebox/privatedata";
}

async function getStatus(return_result) {


parsedResult = JSON.parse(JSON.stringify(return_result));
alert(`${parsedResult.status} ${parsedResult.detail}`);

 

}

async function scanCode() {
// alert("scan!");

window.location.href="/scanner/scan";

}




async function updateOffer() {
    
    var data;
   
    var input_card_title = document.getElementById("input_card_title");
    var input_card_content = document.getElementById("input_card_content");

   
    // user_confirm = confirm(`Are you sure you want to proceed with updating ${input_card_title.value} ${record_kind}?`) ;
    // if (user_confirm == false) {return;}
    

    const submit_data = {"title": input_card_title.value,
                          "content": input_card_content.value,
                          "kind": global_record_kind,
                          "final_kind":global_record_kind };

    

   await fetch('/records/updaterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    
    // window.location.href=referer;
    // window.history.back();
    window.location.href="/records/offerlist?kind={{record_kind}}";
    // console.log(referer);
      }

async function deleteGrant() {
  

  user_confirm = confirm(`Are you sure you want to proceed with deleting {{ card }}?`) ;

  const submit_data = {"title": "{{ card }}", "kind": global_record_kind};

    

   await fetch('/records/deleterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    window.location.href=referer ;

}      



</script>

<script>

function consoleLog(data) {
    var logElement = document.getElementById('log');
    logElement.innerHTML += data + '\n';
  };

async function getBlob() {
  try {
    const res = await fetch("/records/blob", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        record_name: global_card,
        record_kind: global_record_kind
      })
    });

    if (!res.ok) {
      consoleLog(`No blob to fetch (${res.status})`);
      return;
    }

    const mimeType = res.headers.get("Content-Type") || "";
    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const img = document.getElementById("dynamic_image");
    const pdf = document.getElementById("pdf_viewer");

    // Cleanup previous URLs
    if (img?.dataset.blobUrl) URL.revokeObjectURL(img.dataset.blobUrl);
    if (pdf?.dataset.blobUrl) URL.revokeObjectURL(pdf.dataset.blobUrl);

    if (img) img.style.display = "none";
    if (pdf) pdf.style.display = "none";

    if (mimeType.startsWith("image/") && img) {
      img.src = objectUrl;
      img.dataset.blobUrl = objectUrl;
      img.style.display = "block";
      consoleLog(`${mimeType} is fetched and rendered!`);
      return;
    }

    if (mimeType === "application/pdf" && pdf) {
      pdf.src = objectUrl;
      pdf.dataset.blobUrl = objectUrl;
      pdf.style.display = "block";
      consoleLog(`${mimeType} is fetched and rendered!`);
      return;
    }

    // Fallback
    window.open(objectUrl, "_blank");

  } catch (err) {
    consoleLog(`Error rendering blob: ${err}`);
  }
  
}

getBlob();
</script>

{% endblock %}

{% block page_content %}



<div class="center-text">
    <h1> {{grant_label}}  Record</h1>  
    <div class="card">
      <div class="card-title">{{ card.split(':')[1] if ':' in card else card }}</div>
      <div class="card-content">{{ content }}</div>
    </div>
    <div class="center-text">
      <br>Original Record<br><br>
      <img id="dynamic_image" alt="" style="display: block; margin: 0 auto;" />
      <br>
      <iframe id="pdf_viewer" style="display:none; width:100%; height:600px; border:1px solid #ccc;"></iframe>
      <br><br>
      
    </div>
    <button onclick="deleteGrant()">Delete</button>
    <br><br>
    <button onclick="goBack()">Back</button>
    <br><br>
    <button onclick="backToProfile()">Home</button>
    
</div>



   

<div class="center-text">    
    <hr>
    {{action_mode}} {{record_kind}}  {{referer}} grant.html   
</div>
<div class="center-text">    
 
    <hr>
    <pre id="log"></pre>  
</div>

     
<script>
  setDarkMode();
</script>


{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}