{% extends "uxbase.html" %}

{% block title %}Request Record{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="/static/records-modern.css">


<script type="module">
  import * as pdfjsLib from "/js/pdf.mjs";

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "/js/pdf.worker.mjs";

  window.pdfjsLib = pdfjsLib;  // expose globally if needed
</script>


<script>


var global_transmit_nauth = "";
var global_listen_nauth;

function consoleLog(data) {
    var logElement = document.getElementById('log');
    logElement.innerHTML += data + '\n';
  };

function setRequestStatus(message) {
  const statusEl = document.getElementById("span_msg_status");
  if (statusEl) {
    statusEl.textContent = message;
  }
}

function centerQrImageInView() {
  const qrImg = document.getElementById("img_qr_display");
  if (!qrImg) return;
  qrImg.scrollIntoView({
    behavior: "smooth",
    block: "center",
    inline: "nearest"
  });
}

async function requestbyNFC(grant_kind, record_label, nauth, nfc_pin) {
   
    var qr_img_func = document.getElementById("img_qr_display");
    // userMessage(`Requesting ${nfc_amount} for ${nfc_currency}, please wait...`);
    const maskedNauth = nauth.slice(0, 7) + '...' + nauth.slice(-7);
    consoleLog(`Requesting by NFC. ${grant_kind} ${nfc_pin} ${maskedNauth}. \n Please wait...`);
    setRequestStatus("Tap NFC card to request record...");
    
    var nfc_token;
    // var nfc_comment = document.getElementById("ln_recipient_memo").value;
    
    if ("NDEFReader" in window) {
      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        ndef.onreading = async event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {

            nfc_token = decoder.decode(record.data);
          }
         //  alert(`Present ${grant_kind} ${nfc_token}` );
         qr_img_func.src = "/img/circle-256.gif";
         consoleLog(`NFC card read successfully!`);
         setRequestStatus("Card read. Processing request...");

         

         await submitProof(nfc_token, record_label, grant_kind, nauth, nfc_pin);
         // alert("submitted"); 
         // qr_img_func.src = "/img/hourglass.png";
          
          // submitToken(nfc_amount, nfc_token, nfc_currency,nfc_comment)
          
        }
      } catch(error) {
        consoleLog(error);
        setRequestStatus("NFC read failed. Please try again.");
        qr_img_func.src = "/img/safebox.png";
      }
    } else {
      consoleLog("Web NFC is not supported.");
      setRequestStatus("Web NFC is not supported on this device/browser.");
    }


  }

  async function submitProof(nfc_token, record_label, record_kind, nauth, nfc_pin) {

    // alert(`submit proof ${record_label}`);
    var qr_img_func = document.getElementById("img_qr_display");
    const submit_data =   { "proof_token": nfc_token, 
                            "nauth": nauth, 
                            "label":record_label, 
                            "kind":record_kind,
                            "pin": nfc_pin };
    consoleLog(JSON.stringify(submit_data));
    try {
      const response = await fetch('/records/acceptprooftoken', {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(submit_data)
      });
      const data = await response.json();
      const status = data.status || "ERROR";
      const detail = data.detail || "Proof request did not return a valid response.";
      consoleLog(`${status} ${detail}`);
      setRequestStatus(detail);
      if (status !== "OK") {
        alert(detail);
        qr_img_func.src = "/img/safebox.png";
      } else {
        qr_img_func.src = "/img/circle-256.gif";
        setRequestStatus("Request accepted. Waiting for records...");
      }
    } catch (error) {
      consoleLog(`submitProof error: ${error}`);
      setRequestStatus("Unable to submit NFC proof request.");
      alert("Unable to submit NFC proof request.");
      qr_img_func.src = "/img/safebox.png";
    }
  
  
  
  }



  async function createQRCode() {
  var data;
  var qr_img_func = document.getElementById("img_qr_display");
  var grant_kind = document.getElementById("grant_kind").value;
  var record_label = document.getElementById("record_label").value;
  const nfc_request = document.getElementById("nfc_request_checkbox");
  const compact_qr = document.getElementById("compact_qr_checkbox");



    var scope = `verifier:${grant_kind}`;
    const submit_data = {"scope": scope, "compact": compact_qr.checked  };
    
    console.log(JSON.stringify(submit_data));

    await fetch(`/records/nauth`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(submit_data)         
           
      })
    .then((response) => response.json())
    .then((data) => {
      
     
      global_nauth = data.detail;
      // qr_img_func.src = "/safebox/qr/"+ global_nauth;
    
  

    });

  if (nfc_request.checked == true) {  
      qr_img_func.src = "/img/nfc.png";
      // alert("Please tap NFC card!");
      const nfc_pin = prompt("Please enter PIN") || "0000";
      // const nfc_pin = "9140"
      
      await requestbyNFC(grant_kind, record_label, global_nauth,nfc_pin);
                     
  } else {

    console.log(`grant kind: ${grant_kind}`);

    // qr_img_func.src="/img/circle-256.gif";
    qr_img_func.src = "/safebox/qr/"+ global_nauth;
    setTimeout(centerQrImageInView, 80);

  }
   
  listenForPresentation(global_nauth);






// addCard("test","test","testbbo");
      
      
      }
</script>

<div class="center-text">
  <h1>Request Record</h1>
  <span id="span_msg_status">Select Record Type:</span>   

  <br><br>

  <select id="grant_kind" name="grant_kind" style="font-size: 16px;">    
    {% for entry in grant_kinds %}
      <option value="{{ entry[0] }}">{{ entry[1] }}</option>
    {% endfor %}
  </select>

  <br><br>
  Label:
  <br><br>

  <input
    type="text"
    id="record_label"
    name="record_label"
    list="subtypes"
    style="width:60%;"
    placeholder="default"
  />

  <datalist id="subtypes">
    <!-- will be filled dynamically -->
  </datalist>

  <br><br>
  <label>
    <input type="checkbox" id="nfc_request_checkbox" name="nfc_request_checkbox">
    Request by NFC
    <input type="checkbox" id="compact_qr_checkbox" name="compact_qr_checkbox" checked="checked">
    Compact QR Code
    <br><br>
  </label>

  <img id="img_qr_display" src="/img/safebox.png" onclick="createQRCode()">
</div>

<script>
  // Turn the Jinja grant_kinds into a JS array
  const grantKinds = {{ grant_kinds | tojson }};

  // Build a map: code -> { label, subtypes[] }
  const grantKindMap = {};
  grantKinds.forEach(entry => {
    const [code, label, subtypes] = entry;
    grantKindMap[code] = {
      label: label,
      subtypes: subtypes || []
    };
  });

  const selectEl = document.getElementById('grant_kind');
  const datalistEl = document.getElementById('subtypes');
  const labelInput = document.getElementById('record_label');

function updateSubtypes() {
  const code = selectEl.value;
  const info = grantKindMap[code] || { subtypes: [] };

  // Make a copy so you don't mutate the original map
  const subtypes = [...info.subtypes];

  // ALWAYS add "default" as the first subtype
  subtypes.unshift("default");

  // CLEAR the input whenever a new grant kind is selected
  labelInput.value = "";

  // Clear existing datalist options
  datalistEl.innerHTML = '';

  if (!subtypes.length) {
    labelInput.placeholder = 'label';
    return;
  }

  // Use first subtype as placeholder ("default")
  labelInput.placeholder = subtypes[0];

  subtypes.forEach(st => {
    const opt = document.createElement('option');
    opt.value = st;
    datalistEl.appendChild(opt);
  });
}

  // Update on change + once on load
  selectEl.addEventListener('change', updateSubtypes);
  window.addEventListener('DOMContentLoaded', updateSubtypes);
</script>

<script>



async function backToProfile() {


window.location.href="/safebox/access" ;

}

async function listenForPresentation(nauth) {
    
  console.log(`listen for request presentation ${nauth}`);
    
    // const ws = new WebSocket(`wss://{{request.url.hostname}}/records/ws/request/${nauth}`);  
    const ws = new WebSocket(`{{ws_url}}${nauth}`);
    console.log("{{ws_url}}");
    
       
      // alert("listen for request");
      // alert(span_msg_status.textContent)
      span_msg_status.textContent = "Listening for request...";
      ws.onopen = () => console.log("WebSocket connected");
      ws.onmessage = (event) => {
      console.log("Message received for listen for request:", event.data);
      const response = JSON.parse(event.data);  
    
      if (response.status == "TIMEOUT")
      {
        alert("Record presentation has timed out. Please retry.");
        span_msg_status.textContent = "Request presentation has timed out. Please retry.";
      }
    
      if (response.status == "VERIFIED")
      {
        
        // alert(`Request has been received! ${JSON.stringify(response.detail)}`);
        span_msg_status.textContent = "Request has been received!";
        
        for (const rec of response.records) {
          //console.log(rec);
          // addCard(rec.tag, `${response.result}`,rec.payload);
          addCard(rec.tag,rec.content, rec.verification, rec.picture, rec.is_attested, rec.original_record);
          
          
        }

        // addCard(response.detail.tag, `${response.result}`,response.detail.payload);
        var qr_img_func = document.getElementById("img_qr_display");
      
        qr_img_func.src = "/img/check.png";

      }
      
      
      ws.close()
      };
      ws.onclose = () => console.log("WebSocket closed");
      
    
    
    
    }




</script>

{% endblock %}

{% block page_content %}





<div id="card-container"></div>

<script>

  function getRightSide(str) {
      const idx = str.indexOf(':');
      if (idx === -1) return str;        // No delimiter â†’ return original
      return str.substring(idx + 1);     // Return everything after the colon
    }

async function fetchOriginalBlob(record, mediaHost) {
  if (!mediaHost) return;
  mediaHost.innerHTML = "";

  try {
    const res = await fetch("/records/originalblob", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(record)
    });

    // ðŸš« If not found â†’ show nothing
    if (!res.ok) {
      return;
    }

    const mimeType = (res.headers.get("Content-Type") || "")
                        .split(";")[0]
                        .trim()
                        .toLowerCase();

    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    // ðŸ–¼ IMAGE HANDLING
    if (mimeType.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = objectUrl;
      img.style.width = "100%";
      img.style.height = "auto";
      img.style.display = "block";
      img.style.marginTop = "10px";
      mediaHost.appendChild(img);

      return;
    }

    // ðŸ“„ PDF HANDLING (PDF.js)
    if (mimeType === "application/pdf") {

      const loadingTask = pdfjsLib.getDocument({
        url: objectUrl,
        standardFontDataUrl: "/js/standard_fonts/"
      });

      const pdf = await loadingTask.promise;
      let currentPage = 1;
      const totalPages = pdf.numPages;

      const controls = document.createElement("div");
      controls.style.display = "flex";
      controls.style.flexDirection = "column";
      controls.style.alignItems = "center";
      controls.style.justifyContent = "center";
      controls.style.gap = "6px";
      controls.style.margin = "8px 0 10px";

      const navRow = document.createElement("div");
      navRow.style.display = "flex";
      navRow.style.alignItems = "center";
      navRow.style.justifyContent = "center";
      navRow.style.gap = "10px";
      navRow.style.flexWrap = "nowrap";
      navRow.style.width = "100%";

      const prevBtn = document.createElement("button");
      prevBtn.type = "button";
      prevBtn.textContent = "Prev";
      prevBtn.style.width = "88px";
      prevBtn.style.minWidth = "88px";
      prevBtn.style.padding = "8px 10px";
      prevBtn.style.margin = "0";

      const pageLabel = document.createElement("span");
      pageLabel.style.fontSize = "0.9rem";
      pageLabel.style.color = "#cfd8ff";

      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.textContent = "Next";
      nextBtn.style.width = "88px";
      nextBtn.style.minWidth = "88px";
      nextBtn.style.padding = "8px 10px";
      nextBtn.style.margin = "0";

      navRow.appendChild(prevBtn);
      navRow.appendChild(nextBtn);
      controls.appendChild(navRow);
      controls.appendChild(pageLabel);
      mediaHost.appendChild(controls);

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.style.display = "block";
      canvas.style.marginBottom = "12px";
      mediaHost.appendChild(canvas);

      async function renderPage(pageNum) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1 });
        const hostWidth = Math.max(320, mediaHost.clientWidth || viewport.width);
        const scale = hostWidth / viewport.width;
        const scaledViewport = page.getViewport({ scale: scale });

        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;
        pageLabel.textContent = `${pageNum}/${totalPages}`;
        prevBtn.disabled = pageNum <= 1;
        nextBtn.disabled = pageNum >= totalPages;

        await page.render({
          canvasContext: context,
          viewport: scaledViewport
        }).promise;
      }

      prevBtn.addEventListener("click", async () => {
        if (currentPage > 1) {
          currentPage -= 1;
          await renderPage(currentPage);
        }
      });

      nextBtn.addEventListener("click", async () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          await renderPage(currentPage);
        }
      });

      await renderPage(currentPage);

      return;
    }

    // Anything else â†’ do nothing

  } catch (err) {
    console.log("Render error:", err);
  }
}


  // Function to create and add a card
  function addCard(title, content, verification, picture, is_attested, original_record) {
    // Create a card element
    const card = document.createElement('div');
    card.className = 'card';

    // Create and add the title element
    const cardTitle = document.createElement('div');
    cardTitle.className = 'card-title';
    cardTitle.textContent = getRightSide(title[0]);
    card.appendChild(cardTitle);



    // Create and add the content element
    const cardContent = document.createElement('div');
    cardContent.className = 'card-content';
    cardContent.textContent = content;  
    card.appendChild(cardContent); 

        // Create and add the content element
    const cardVerification = document.createElement('div');
    cardVerification.className = 'card-content';
    cardVerification.textContent = verification;  
    cardVerification.style.textAlign = 'center';
    card.appendChild(cardVerification); 

    // Create and add the ownerprofile element

    const cardOwnerProfile = document.createElement('div');
    cardOwnerProfile.className = 'card-content';    
    cardOwnerProfile.style.textAlign = 'center';
    

    // Create the image element
    if (picture) {

      const img = document.createElement('img');
      img.src = picture;          // picture is the image URL
      img.alt = 'Card image';
      img.style.maxWidth = '100%'; // keep it responsive
      img.style.height = 'auto';
      // Add image to the container
      cardOwnerProfile.appendChild(img);
      
      // Add container to the card
       
    } else {
    
      cardOwnerProfile.textContent = "No Owner Profile Found";
    }

    card.appendChild(cardOwnerProfile);

    const cardMedia = document.createElement("div");
    cardMedia.className = "card-content";
    cardMedia.style.marginTop = "8px";
    cardMedia.style.width = "100%";
    card.appendChild(cardMedia);
  


    // figure out what to do with the card conte

    // Append title and content to the card

    try {

        if (typeof cardContent == 'object' ) {
        console.log(cardContent);



        } else {
          console.log("string");
        }




      } catch (error) {
        console.error("Invalid JSON:", error.message);
    }


    if (original_record != null) {
      fetchOriginalBlob(original_record, cardMedia);
    }

    

    // Keep cards non-interactive to avoid accidental alerts while paging embedded PDFs.

    // Append the card to the container
    const container = document.getElementById('card-container');
    container.appendChild(card);
  }





async function getStatus(return_result) {


parsedResult = JSON.parse(JSON.stringify(return_result));
// alert(`${parsedResult.status} ${parsedResult.detail}`);
alert("Done!");

 

}

setDarkMode();



</script>
<div class="center-text">

  <button onclick="backToProfile()">Home</button>
  <br>
 
     
        
</div>
     
<div class="center-text">
  <hr>
   <pre id="log"></pre>  
   <br><br>


</div>


{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}
