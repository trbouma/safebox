{% extends "uxbase.html" %}

{% block title %}Offer Record{% endblock %}
{% block head %}
{{ super() }}



<script>

var global_naddr = "";
var global_transmit_nauth = "None";
var global_offer_kind = {{offer_kind}};
var global_grant_kind = {{grant_kind}};
var global_offer_card = "{{card}}";
var global_kem_public_key = "None";
var global_kemalg = "None";


var record_kind = parseInt("{{record_kind}}");
var referer = "{{referer}}";


function consoleLog(data) {
    var logElement = document.getElementById('log');
    logElement.innerHTML += data + '\n';
  };

async function backToProfile() {

window.location.href="/safebox/access" ;

}

async function goBack() {
    window.history.back();
}

async function privateData() {

window.location.href="/safebox/privatedata";
}

async function getStatus(return_result) {


parsedResult = JSON.parse(JSON.stringify(return_result));
alert(`${parsedResult.status} ${parsedResult.detail}`);

 

}

async function scanCode() {
// alert("scan!");

window.location.href="/scanner/scan";

}


async function shareCard() {

  alert("Coming!");
  
}

async function editOffer() {
    
     


   
    user_confirm = confirm(`Are you sure you want to proceed with updating {{card}}`) ;
    if (user_confirm == false) {return;}

    // window.location.href=`/records/displayrecord?card={{card}}&action_mode=edit&kind=${global_offer_kind}`;

    window.location.href=`/records/manageoffer?card={{card}}&action_mode=edit&kind=${global_offer_kind}`;
    

    const submit_data = {"title": {{card|tojson}},
                          "content": {{content|tojson}},
                          "kind": global_offer_kind,
                          "final_kind":global_grant_kind };

    

   await fetch('/records/updaterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    
    window.location.href=referer;
      }

async function deleteOffer() {
  var offer_card = document.getElementById("offer_card");
  console.log(`${offer_card}`)
  user_confirm = confirm(`Are you sure you want to proceed with deleting {{card}}?`) ;

  const submit_data = {"title": "{{card}}", "kind": record_kind};

    

   await fetch('/records/deleterecord', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => data);

    window.location.href=referer ;

}  

  async function submitOffer(nfc_token, nauth) {

    consoleLog(`submit nfc_token ${nfc_token} ${nauth}`);
    const submit_data = {"offer_token": nfc_token, "nauth": nauth };
    await fetch('/records/acceptoffertoken', {
    method: "POST",
    headers: {"Content-Type": "application/json"},        
    body: JSON.stringify(submit_data)         
  })
  .then((response) => response.json())   
  .then((data) => { consoleLog(`done ${data.detail}`)});
  
  
  
  }  


async function requestbyNFC(offer_kind, nauth) {
   
    var qr_img_func = document.getElementById("img_qr_display");
    // userMessage(`Requesting ${nfc_amount} for ${nfc_currency}, please wait...`);
    const maskedNauth = nauth.slice(0, 7) + '...' + nauth.slice(-7);
    consoleLog(`Requesting by NFC. ${offer_kind} ${maskedNauth}. \n Please wait...`);
    var nfc_token;
    // var nfc_comment = document.getElementById("ln_recipient_memo").value;
    
    if ("NDEFReader" in window) {
      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        ndef.onreading = event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {

            nfc_token = decoder.decode(record.data);
          }
         // alert(`Offer ${offer_kind} ${nfc_token}` );
         qr_img_func.src = "/img/nfc-check.png";
         consoleLog(`NFC card read successfully!`);

         

         submitOffer(nfc_token, nauth);
          
          
          // submitToken(nfc_amount, nfc_token, nfc_currency,nfc_comment)
          
        }
      } catch(error) {
        consoleLog(error);
      }
    } else {
      consoleLog("Web NFC is not supported.");
    }


  }

async function createQRCode() {
    
    var data;
    var qr_img_func = document.getElementById("img_qr_display");
    const nfc_offer = document.getElementById("nfc_offer_checkbox");
    var offer_kind =  {{offer_kind}};
    var scope = "offer:{{offer_kind}}";
    var grant = "record:{{grant_kind}}";
    const compact_qr = document.getElementById("compact_qr_checkbox");
   
    // alert(scope);
    consoleLog(`Create QR code with scope: ${scope}`);

    qr_img_func.src="/img/circle-256.gif";   
    
    const submit_data = {"scope": scope, "grant": grant, "compact": compact_qr.checked };
    console.log(`scope: ${scope} grant: ${grant}`);

    await fetch(`/records/nauth`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(submit_data)         
           
      })
 .then((response) => response.json())
 .then((data) => {  // alert(data.detail);
                    global_nauth = data.detail;
                    // var qr_img_func = document.getElementById("img_qr_display");
                    // qr_img_func.src = "/safebox/qr/"+ global_nauth;
                    console.log(`nauth: ${global_nauth}`);

                }
 
                 // getQRStatus(data)
 );

   if (nfc_offer.checked == true) {  
      qr_img_func.src = "/img/nfc.png";
      consoleLog("Tap NFC card!");
      
      await requestbyNFC(offer_kind, global_nauth);
                     
  } else {

    // console.log(`grant kind: ${grant_kind}`);

    // qr_img_func.src="/img/circle-256.gif";
    qr_img_func.src = "/safebox/qr/"+ global_nauth;

  }

 // const ws = new WebSocket(`wss://{{request.url.hostname}}/records/ws/listenfornauth/${global_nauth}`);
 const ws = new WebSocket(`{{ws_url}}${global_nauth}`);
  console.log(`{{ws_url}}${global_nauth}`);
   

    ws.onopen = () => console.log("WebSocket connected");
    ws.onmessage = (event) => {
      console.log("Message received:", event.data);
      const response = JSON.parse(event.data);  
      global_transmit_nauth = response.nauth;
      client_name = response.name;
      client_transmittal_kind = response.transmittal_kind;
      client_transmittal_relays = response.transmittal_relays;
      global_kem_public_key = response.kem_public_key;
      global_kemalg = response.kemalg;
    // client_name = response.name;
    // alert(`Client is authenticated! Ready to transmit files.`); 
    if (global_transmit_nauth) {
    // alert(`Client is authenticated! Ready to transmit files.`); 
      qr_img_func.src="/img/check.png";
    } else {
    // alert(`Authentication has timed out! Please regenerate QR code`);  
      qr_img_func.src="/img/safebox.png";
    }
    // ws.close()
    // alert('Ready to transmit offer');
    offerRecord();
    
    
  };
  ws.onclose = () => console.log("WebSocket closed");
  

}

async function offerRecord() {

    
    if (global_transmit_nauth=="None" && client_nauth == "None" ) {
      alert(`Please authenticate your credential recipient!`);
      return;
    }

    // if (confirm(`Are you sure you want to send?`)) {
      // alert(`Sending...`);
    // } else {return;}
  
    var data;
    if (global_transmit_nauth == "None"){
      
      nauth_to_transmit = client_nauth;

    } else {
      nauth_to_transmit = global_transmit_nauth;
    }
   


  const submit_data = { "nauth": nauth_to_transmit,
                        "originating_kind": global_offer_kind,
                        "final_kind": global_grant_kind,
                        "record_name": global_offer_card,
                        "kem_public_key": global_kem_public_key,
                        "kemalg": global_kemalg
   };

  console.log(`data to submit: ${submit_data.nauth} ${submit_data.final_kind}`) ;

  await fetch('/records/transmit', {
       method: "POST",
       headers: {"Content-Type": "application/json"},        
       body: JSON.stringify(submit_data)         
      })
   .then((response) => response.json())
   .then((data) => { console.log(`Done! ${data.status} ${data.detail}`)}
   
   // getStatus(data)
   );

   // window.location.href=referer;
     }

let selectedFile = null;

function handleFileSelected() {
  const input = document.getElementById("file_input");
  selectedFile = input.files[0];

  if (!selectedFile) return;

  document.getElementById("file_name").innerText =
    `Selected: ${selectedFile.name} (${selectedFile.size} bytes)`;

  consoleLog(`File selected: ${selectedFile.name}`);

  const img = document.getElementById("dynamic_image");
  const pdf = document.getElementById("pdf_viewer");

  // Clean up old blob URLs
  if (img.dataset.blobUrl) {
    URL.revokeObjectURL(img.dataset.blobUrl);
    img.dataset.blobUrl = "";
  }
  if (pdf.dataset.blobUrl) {
    URL.revokeObjectURL(pdf.dataset.blobUrl);
    pdf.dataset.blobUrl = "";
  }

  // Hide both by default
  img.style.display = "none";
  pdf.style.display = "none";

  // IMAGE PREVIEW
  if (selectedFile.type.startsWith("image/")) {
    const blobUrl = URL.createObjectURL(selectedFile);
    img.src = blobUrl;
    img.dataset.blobUrl = blobUrl;
    img.style.display = "block";
    return;
  }

  // PDF PREVIEW
  if (selectedFile.type === "application/pdf") {
    const blobUrl = URL.createObjectURL(selectedFile);
    pdf.src = blobUrl;
    pdf.dataset.blobUrl = blobUrl;
    pdf.style.display = "block";
    return;
  }

  // Fallback
  consoleLog(`No preview available for type: ${selectedFile.type}`);
}

async function uploadSelectedFile() {
  if (!selectedFile) {
    alert("Please choose a file first.");
    return;
  }

  const formData = new FormData();
  formData.append("file", selectedFile);  
  formData.append("record_kind", global_offer_kind);
  formData.append("card", "{{card}}");
  formData.append("content", "{{content}}");

  await fetch("/records/upload", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    consoleLog(`Upload complete: ${data.detail}`);
    alert(data.detail);
  })
  .catch(err => {
    consoleLog(`Upload error: ${err}`);
  });
}


async function getBlob() {
  try {
    const res = await fetch("/records/blob", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        record_name: global_offer_card,
        record_kind: global_offer_kind
      })
    });

    if (!res.ok) {
      consoleLog(`No blob to fetch (${res.status})`);
      return;
    }

    const mimeType = res.headers.get("Content-Type") || "";
    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const img = document.getElementById("dynamic_image");
    const pdf = document.getElementById("pdf_viewer");

    // Cleanup previous URLs
    if (img?.dataset.blobUrl) URL.revokeObjectURL(img.dataset.blobUrl);
    if (pdf?.dataset.blobUrl) URL.revokeObjectURL(pdf.dataset.blobUrl);

    if (img) img.style.display = "none";
    if (pdf) pdf.style.display = "none";

    if (mimeType.startsWith("image/") && img) {
      img.src = objectUrl;
      img.dataset.blobUrl = objectUrl;
      img.style.display = "block";
      return;
    }

    if (mimeType === "application/pdf" && pdf) {
      pdf.src = objectUrl;
      pdf.dataset.blobUrl = objectUrl;
      pdf.style.display = "block";
      return;
    }

    // Fallback
    window.open(objectUrl, "_blank");

  } catch (err) {
    consoleLog(`Error rendering blob: ${err}`);
  }
}

getBlob();
</script>

{% endblock %}

{% block page_content %}



<div class="center-text">
    <h1>Offer {{offer_label}} Record </h1>

   
<div 
  id="offer_card" 
  onclick="createQRCode()" 
  style="
    width: 80%;
    border-radius: 12px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    padding: 16px;
    margin: 20px auto;
    cursor: pointer;
    background-color: rgb(136, 33, 225);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  "
  onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
  onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';"
>
  <h3 style="margin-top: 0;">{{ card }}</h3>
  <p style="white-space: pre-wrap;">{{ content }}</p>
</div>
    <div class="center-text">
      <br>Original Record<br><br>
      <img id="dynamic_image" alt="" style="display: block; margin: 0 auto;" />
      <br>
      <iframe id="pdf_viewer" style="display:none; width:100%; height:600px; border:1px solid #ccc;"></iframe>
    </div>
    
    <h2>Offer {{offer_label}} Record to Recipient?</h2>
    Click below to authenticate with {{offer_kind_label}} recipient. 
    <br>Please ask them to scan the generated QR code.
    <br><br>
    <label>
    <input type="checkbox" id="nfc_offer_checkbox" name="nfc_offer_checkbox">
    Offer by NFC
    <input type="checkbox" id="compact_qr_checkbox" name="compact_qr_checkbox" checked="checked">
    Compact QR Code
  <br><br>
    <br><br>
    </label>
    
    <img id="img_qr_display" onclick="createQRCode()"  src="/img/safebox.png" >
    <br><br>
    <hr>
    <h3>Manage Original Record</h3>

    <input type="file" id="file_input" style="display: none;" onchange="handleFileSelected()"/>
    <button onclick="document.getElementById('file_input').click()">Select Original Record</button>
    <div id="file_name" style="margin-top: 8px; font-style: italic;"></div>    
    <button onclick="getBlob()">Retrieve Original Record</button>
    <br><br>
    <button onclick="uploadSelectedFile()">Upload Original Record</button>
    <br><br>
    <button onclick= "editOffer()">Edit {{offer_label}} Record Offer</button>
    <br><br>
    <button onclick="deleteOffer()">Delete {{offer_label}} Record Offer</button>
    <br><br>
    <button onclick="goBack()">Back</button>
    <br><br>
    <button onclick="backToProfile()">Home</button>
    
</div>


   

<div class="center-text">    
    <hr>
    {{action_mode}} {{record_kind}}  {{referer}}   
    <hr>
    <pre id="log"></pre>  
</div>

     
<script>
  setDarkMode();
</script>


{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}