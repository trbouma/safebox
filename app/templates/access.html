{% extends "uxbase.html" %}

{% block title %}Safebox{% endblock %}
{% block head %}
{{ super() }}

<style>
  :root {
    --sb-brand-navy: #000060;
    --sb-brand-light: #f6f6f6;
    --sb-brand-blue-1: #5267ec;
    --sb-brand-blue-2: #5369ec;
    --sb-bg-deep: #090c1a;
    --sb-bg-mid: #0d1124;
    --sb-panel: #121a33;
    --sb-panel-border: #2f3d67;
    --sb-text-main: #eef2ff;
    --sb-text-sub: #bcc7ec;
  }

  .center-text {
    width: min(96vw, 880px);
    max-width: 880px;
    margin: 0 auto;
    padding: 18px;
    box-sizing: border-box;
    border: 1px solid var(--sb-panel-border);
    border-radius: 16px;
    background: var(--sb-panel);
    box-shadow: 0 14px 34px rgba(0, 0, 0, 0.42);
  }

  /* Consistent vertical rhythm */
  .center-text > * {
    margin-top: 0;
    margin-bottom: 0;
  }

  .center-text > * + * {
    margin-top: 10px;
  }

  /* Legacy layout uses many direct-child <br> nodes; neutralize them */
  .center-text > br,
  .center-text > br + br {
    margin-top: 0 !important;
  }

  .center-text form > * + * {
    margin-top: 8px;
  }

  .balance-currency-selector {
    margin-bottom: 12px;
  }

  #ln_select_invoice_currency,
  #ln_select_currency {
    display: block;
    margin: 10px auto 0;
  }

  h1, h2, h3, h5, p, span, pre, label, a, b {
    color: var(--sb-text-main);
  }

  a {
    color: #a6beff;
    font-family: "Josefin Sans", "Trebuchet MS", Tahoma, sans-serif;
  }

  input[type="text"],
  input[type="number"],
  textarea,
  select {
    background: #0d1430;
    color: #e2e8ff;
    border: 1px solid #39497a;
    border-radius: 10px;
    padding: 10px 12px;
    box-sizing: border-box;
    font-family: "Josefin Sans", "Trebuchet MS", Tahoma, sans-serif;
  }

  .center-text input[type="text"],
  .center-text input[type="number"],
  .center-text textarea,
  .center-text select {
    width: 90% !important;
    margin-left: auto;
    margin-right: auto;
    display: block;
  }

  textarea {
    min-height: 92px;
    resize: vertical;
  }

  input[type="text"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    outline: 2px solid var(--sb-brand-blue-1);
    outline-offset: 1px;
    border-color: var(--sb-brand-blue-1);
  }

  button {
    background: linear-gradient(135deg, var(--sb-brand-blue-1), var(--sb-brand-blue-2));
    color: #ffffff;
    border: 0;
    border-radius: 12px;
    font-weight: 600;
    font-family: "Inter", "Trebuchet MS", Tahoma, sans-serif;
    width: 90%;
    display: block;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
    padding: 10px 12px;
  }

  #payment_notification,
  #pay_to_message,
  #log,
  #npub {
    display: block;
    border: 1px solid #3c518b;
    border-radius: 10px;
    background: #0d1430;
    color: #cad9ff;
    padding: 10px 12px;
    overflow-wrap: anywhere;
  }

  #payment_notification {
    border: 0;
    background: transparent;
    padding: 0;
    color: var(--sb-text-main);
  }

  /* Keep the top action area compact */
  .center-text > #payment_notification + #ln_scan_button {
    margin-top: 0;
  }

  .center-text > #ln_scan_button + * {
    margin-top: 12px;
  }

  #img_qr_display {
    border-radius: 14px;
    border: 1px solid #3c518b;
    background: #0d1430;
    max-width: 260px;
    width: 100%;
    height: auto;
  }

  .center-text br {
    display: block;
    content: "";
    margin-top: 4px;
  }

  .center-text button + br {
    margin-top: 0;
  }

  .center-text br + button {
    margin-top: 4px;
  }

  .center-text button + br + br {
    margin-top: 0;
  }

  .center-text button + br + br + button {
    margin-top: 4px;
  }

  .center-text > button {
    margin-top: 6px;
  }

  .btn-stack {
    display: grid;
    gap: 6px;
    margin-top: 8px;
  }

  .btn-stack button {
    margin-top: 0 !important;
  }

  .account-box {
    border: 1px solid #3c518b;
    border-radius: 12px;
    background: #0d1430;
    padding: 12px;
    margin-top: 10px;
    box-sizing: border-box;
    overflow: hidden;
  }

  .request-qr-output {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin-top: 10px;
    overflow-x: auto;
  }

  @media (max-width: 700px) {
    .center-text {
      padding: 14px;
    }
    button {
      width: 100%;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100% !important;
    }
  }
</style>




<script>

  var ux_mode = "init";

  var reveal_seed_phrase = false;
  var reveal_access_key = false;
  var reveal_balance = true;
  var starting_balance = "{{acorn.balance}}";
  // var orginal_background = document.body.style.backgroundColor ;
  var onboard = "{{onboard}}";
  var action_mode = "{{action_mode}}";
  var action_data = "{{action_data}}";
  var action_amount = "{{action_amount if action_amount is not none else ''}}";
  var action_comment = "{{action_comment if action_comment else ''}}";
  var reset_to_home_scheduled = false;
  var clipboard_data = "*** MY IMPORTANT DATA ***\n\nService: https://{{request.url.hostname}} \n\nAccess Key: \n\n{{account_access_key}} \n\nRecovery Phrase (12 words):\n\n{{acorn.seed_phrase}}\n\n*** END OF MY IMPORTANT DATA ***"
  var backup_message = "Your important data is copied to the clipboard! \n\nPlease save your access key and recovery phrase to a secure and private place. \n\nDon't delay. WRITE IT DOWN! ";
  var onboard_msg = "Welcome to {{branding}}! \n\nYou are automatically and securely logged in! \n\nWrite down your access key as soon as you can. You can find your access key at the bottom of the page.  \n\nBy pressing OK, you agree to the terms and conditions of this awesome experimental service!";
  var lighting_invoice_data = "";


  if (onboard=="True") {
  // alert(onboard_msg);
  }

  function scheduleAccessReload(delayMs = 900) {
    if (reset_to_home_scheduled) return;
    reset_to_home_scheduled = true;
    setTimeout(() => {
      window.location.href = "/safebox/access";
    }, delayMs);
  }

  async function getEcashStatus(data) {

    var status = JSON.stringify(data["status"]);
    var detail = JSON.stringify(data["detail"]);
    alert(detail);
    window.location.href="/safebox/access";
    

  }

  if (action_mode=="ecash") {
    
    const submit_data = {"ecash_token": action_data };
    // alert("ecash");

     fetch('/safebox/acceptecash', {
           method: "POST",
           headers: {"Content-Type": "application/json"},        
           body: JSON.stringify(submit_data)         
           })
         .then((response) => response.json())
         .then((data) => getEcashStatus(data));



    }


  async function attest() {

  window.location.href="/safebox/attest/";

  } 

    async function trust() {

  window.location.href="/safebox/trust/";

  } 

  async function logout() {
  var data; 
  //alert("log out");
  await fetch('/safebox/logout', {
        method: "GET",
        headers: {"Content-Type": "application/json"}        
               
       })
    .then((response) => response.json())
  
  
  //location.reload();
  window.location.href="/";
  
  

}

async function scanCode() {
// alert("scan!");

window.location.href="/scanner/scan/?wallet_name={{acorn.handle}}";

}

async function dangerZone() {


window.location.href="/safebox/dangerzone/";

}
async function issueCard() {


window.location.href="/safebox/issuecard/";

}

function revealBalance() {
    var heading_balance = document.getElementById("heading_balance");
    var heading_balance = document.getElementById("fiat_balance");
    //alert("reveal balance");
    if (reveal_balance == false) 
    {
        
        // don't worry about linting
        heading_balance.textContent = "(\u20BF{{"{:,}".format(acorn.balance)}})";
        fiat_balance.textContent = "TBD";
        reveal_balance = true;
    }
    else
    {
        heading_balance.textContent = "*********";
        fiat_balance.textContent = "*********";
        reveal_balance = false;
    }
  } 

function revealSeedPhrase() {
    var reveal_seed_phrase_text = document.getElementById("seed_phrase_reveal_text");
    //alert("reveal seed phrase!");
    if (reveal_seed_phrase == false) 
    {
        
        
        reveal_seed_phrase_text.textContent = "{{acorn.seed_phrase}}";
        reveal_seed_phrase = true;
    }
    else
    {
        reveal_seed_phrase_text.textContent = "*********";
        reveal_seed_phrase = false;
    }
  }

  function revealAccessKey() {
    var reveal_access_key_text = document.getElementById("access_key_reveal_text");
    //alert("reveal seed phrase!");
    if (reveal_access_key == false) 
    {
        
        
        access_key_reveal_text.textContent = "{{account_access_key}}";
        reveal_access_key = true;
    }
    else
    {
        access_key_reveal_text.textContent = "*********";
        reveal_access_key = false;
    }
  } 

  

function receivePayment() {

  //alert("Receive Payment {{acorn.handle}}");
  window.location.href="/safebox/profile/{{acorn.handle}}";
}

function onboardFriend() {

  //alert("Onboard");
  window.location.href="/invite?onboard_code={{acorn.handle}}";
}

async function privateData() {

window.location.href="/safebox/privatedata";
}

async function personalMessages() {

window.location.href="/safebox/personalmessages";
}

async function myRecords() {


window.location.href="/records/grantlist";

}



async function requestRecord() {

window.location.href="/records/request";
}

async function myEcash() {

window.location.href="/safebox/ecash";
}
async function doOfferRecord() {

window.location.href="/records/offerlist";

}

async function payOrPass() {

    window.location.href="/public/paypass";
  
}

async function doVerifyCredential() {
// alert('Coming soon!');
window.location.href="/records/verificationrequest";

}

async function doRequestRecord() {
// alert('Coming soon!');
window.location.href="/records/recordrequest";

}

async function myHealthData() {

window.location.href="/safebox/health";

}

async function doAccountHistory() {

window.location.href="/safebox/txhistory";

}

async function copytoClipboard() {

await navigator.clipboard.writeText(clipboard_data);
alert(backup_message);


// ln_invoice_status.textContent = "Lightning Invoice Copied to Clipboard!";

}
async function copyNpub() {

await navigator.clipboard.writeText("{{acorn.pubkey_bech32}}");
alert("Npub copied to clipboard!");




}

async function useClipboard() {
  async function submitScanData(rawData) {
    const tokenData = (rawData || "").trim();
    if (!tokenData) {
      userMessage("No token provided.", "ERROR");
      return;
    }
    await fetch('/scanner/scanresult', {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ data: tokenData })
    }).then((response) => {
      if (response.redirected) {
        window.location.href = response.url;
      }
    });
  }

  try {
    const clipboard_data = await navigator.clipboard.readText();
    await submitScanData(clipboard_data);
  } catch (error) {
    const manualPaste = prompt("Clipboard read is blocked by your browser. Paste token here:");
    if (manualPaste === null) {
      userMessage("Clipboard read blocked. No token pasted.", "ERROR");
      return;
    }
    await submitScanData(manualPaste);
  }
}
async function copyAddress() {

await navigator.clipboard.writeText("{{lightning_address}}");
alert("{{lightning_address}}"+ " copied to clipboard!");




}

async function copyInvoicetoClipoboard(invoice_data) {

await navigator.clipboard.writeText(lighting_invoice_data);
alert("Lightning invoice copied to clipboard!");




}

 async function setOwnerCurrency() {
    
    var data;
   
   
    var owner_currency = document.getElementById("owner_select_currency").value;

    console.log(`owner currency: ${owner_currency}`);

    

    const submit_data = {"npub": null, "local_currency": owner_currency};
    

   await fetch('/safebox/setownerdata', {
        method: "POST",
        headers: {"Content-Type": "application/json"},        
        body: JSON.stringify(submit_data)         
       })
    .then((response) => response.json())
    .then((data) => {data});

    window.location.reload();

      }

function getCreateInvoiceStatus(ln_invoice_status) {
    const create_invoice_button = document.getElementById("ln_create_invoice_button");
    const img_qr_display_pic = document.getElementById("img_qr_display");
    const parsedObject = JSON.parse(JSON.stringify(ln_invoice_status));
    console.log(ln_invoice_status);

    var status = JSON.stringify(ln_invoice_status["status"]);
    var invoice = JSON.stringify(ln_invoice_status["invoice"]);
    console.log("display invoice");
    
    console.log(parsedObject.invoice);
    // img_qr_display_pic.src = "https://safebox.openbalance.app/safebox/qr/"+ parsedObject.invoice;
    img_qr_display_pic.src = "/safebox/qr/"+ parsedObject.invoice;
    lighting_invoice_data = parsedObject.invoice
    img_qr_display_pic.removeEventListener("click", copyAddress);
    img_qr_display_pic.addEventListener("click", copyInvoicetoClipoboard);

    // alert("Payment: " + parsedObject.status + parsedObject.invoice );
    create_invoice_button.textContent = "Invoice Created! ";
    window.scrollTo({ top: 0, behavior: "smooth" });
  

}

function consoleLog(data) {
    var logElement = document.getElementById('log');
    logElement.innerHTML  += data + '\n' ;
  };

  async function userMessage(data, status="INFO"){
    var logElement = document.getElementById('payment_notification');
    logElement.innerHTML = data ;
    if (status=="ERROR") {
      alert(data);
    }
   
  };

  function paytoMessage(data) {
    var logElement = document.getElementById('pay_to_message');
    logElement.innerHTML = data ;
  };

async function requestbyNFC(nfc_amount, nfc_currency, nfc_comment) {
   
    userMessage(`Requesting ${nfc_amount} for ${nfc_currency}, please wait...`);
    consoleLog(`Requesting ${nfc_amount} for ${nfc_currency}, please wait...`);
    document.getElementById("payment_notification").innerText = `Processing payment of ${nfc_amount} ${nfc_currency}`;
    
    var nfc_token;
    // var nfc_comment = document.getElementById("ln_recipient_memo").value;
   
    if ("NDEFReader" in window) {
      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        ndef.onreading = event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {

            nfc_token = decoder.decode(record.data);
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
          // consoleLog(`Pay ${nfc_amount} with ${nfc_token}` );
        
          
          document.getElementById("img_qr_display").src = "/img/circle-256.gif";
          submitToken(nfc_amount, nfc_token, nfc_currency,nfc_comment);
          
        }
      } catch(error) {
        consoleLog(error);
      }
    } else {
      consoleLog("Web NFC is not supported.");
    }


  }

async function submitToken(nfc_amount,nfc_token, nfc_currency,nfc_comment) {

consoleLog(`submitToken ${nfc_amount} ${nfc_token}`);
const submit_data = { "payment_token": nfc_token, 
                      "amount": nfc_amount,
                      "currency": nfc_currency,
                      "comment": nfc_comment                    
                    };

if (nfc_amount == 0) {
  consoleLog(`Advisory: Since 0 was provided for NFC, your minimun amount will be used`);

}
try {
  const response = await fetch('/safebox/requestnfcpayment', {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(submit_data)
  });
  const data = await response.json();
  const status = data.status || "INFO";
  const detail = data.detail || "NFC payment request completed.";
  userMessage(detail, status);
  consoleLog(detail);
  if (status === "ERROR") {
    document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
  } else {
    userMessage("Payment request accepted. Waiting for network confirmation...", "INFO");
  }
} catch (error) {
  consoleLog(`NFC request error: ${error}`);
  userMessage("NFC payment request failed. Please try again.", "ERROR");
  document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
}
window.scrollTo(0, 0);

// window.location.href="/safebox/access" ;



}

async function submitNFCPayment(nfc_amount,nfc_currency, nfc_token, nfc_comment) {

paytoMessage(`Pay to Token ${nfc_amount} ${nfc_currency}${nfc_comment} ${nfc_token} `);

document.getElementById("payment_notification").innerText = `Processing payment of ${nfc_amount} ${nfc_currency}. Please wait...`;
document.getElementById("img_qr_display").src = "/img/circle-256.gif";

const submit_data =   { "nembed": nfc_token, 
                        "currency": nfc_currency,
                        "amount": nfc_amount, 
                        "comment": nfc_comment};

                        
await fetch('/safebox/paytonfctag', {
method: "POST",
headers: {"Content-Type": "application/json"},        
body: JSON.stringify(submit_data)         
}) 
.then((response) => response.json())
.then((data) => {
  const status = data.status || "INFO";
  const detail = data.detail || "NFC payment request completed.";
  paytoMessage(detail);
  userMessage(detail, status);
  consoleLog(detail);
  if (status === "OK") {
    document.getElementById("img_qr_display").src = "/img/green-check.png";
    setTimeout(() => {
      document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
    }, 2500);
  } else {
    document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
  }
  window.scrollTo(0, 0);
  // window.location.href="/safebox/access?action_comment=Complete" ;
})
.catch((error) => {
  consoleLog(`NFC payment error: ${error}`);
  userMessage("NFC payment failed. Please try again.", "ERROR");
  document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
});



// window.location.href=`/safebox/access?action_comment=Payment+sent.` 


}

async function paytoNFC() {

  var nfc_amount = parseFloat(document.getElementById("ln_recipient_amount").value);
  var nfc_comment = document.getElementById("ln_recipient_memo").value;
  var nfc_currency = document.getElementById("ln_select_currency").value;

  
  alert(`Pay to NFC`);
      // var nfc_amount = document.getElementById("input_nfc_amount").value;
      userMessage(`Pay to NFC tag`);
    var nfc_token;
    if ("NDEFReader" in window) {
      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        ndef.onreading = event => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {

            nfc_token = decoder.decode(record.data);
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
          
          
          submitNFCPayment(nfc_amount,nfc_currency,nfc_token, nfc_comment)


         
          
        }
      } catch(error) {
        consoleLog(error);
      }
    } else {
      consoleLog("Web NFC is not supported.");
    }

}

async function requestPayment() {

  const create_invoice_amount = document.getElementById("ln_create_invoice_amount");
  const create_invoice_button = document.getElementById("ln_create_invoice_button");
  const ln_select_invoice_currency = document.getElementById("ln_select_invoice_currency");
  const ln_request_textarea = document.getElementById("ln_request_memo");
  const nfc_payment = document.getElementById("nfc_payment_checkbox");
  
  
  
  
  var ln_create_invoice_amount = parseFloat(create_invoice_amount.value);
  var ln_currency =  ln_select_invoice_currency.value;
  var ln_comment = ln_request_textarea.value
 
  
  
  if (nfc_payment.checked == true) {  
      if (isNaN(ln_create_invoice_amount) || ln_create_invoice_amount < 0) {
        ln_create_invoice_amount = 0;
      }
      alert("Please tap NFC card!");
      await requestbyNFC(ln_create_invoice_amount, ln_currency, ln_comment);
                      return;
  }
  
  create_invoice_button.textContent = "Creating invoice... ";
 
  if (ln_create_invoice_amount <=0 || isNaN(ln_create_invoice_amount)){
    // create_invoice_button.textContent = "Need Amount ";
    alert("Please enter invoice amount.");
    return;

  }
  else
  {
    
    create_invoice_button.textContent = "Invoice Amount ";
    
    const submit_data = { "amount": ln_create_invoice_amount,
                          "currency": ln_currency,
                          "comment": ln_comment};



      await fetch('/safebox/invoice', {
            method: "POST",
            headers: {"Content-Type": "application/json"},        
            body: JSON.stringify(submit_data)         
          })
        .then((response) => response.json())
        .then((data) => getCreateInvoiceStatus(data));

      }
    ux_mode = "wait_invoice";
    }

function clearRequestPaymentFields() {
  const amountEl = document.getElementById("ln_create_invoice_amount");
  const memoEl = document.getElementById("ln_request_memo");
  const nfcEl = document.getElementById("nfc_payment_checkbox");
  if (amountEl) amountEl.value = "";
  if (memoEl) memoEl.value = "";
  if (nfcEl) nfcEl.checked = false;
}




function checkBalance(balance) {

  var heading_balance = document.getElementById("heading_balance");
  var payment_notification = document.getElementById("payment_notification");
  const img_qr_display_pic = document.getElementById("img_qr_display");
  console.log("checking balance from polling: " + ux_mode);
  new_balance =  parseInt(JSON.stringify(balance));
  // alert("new balance " + new_balance);
  if (new_balance > starting_balance)
  {   // alert("Change in funds : " + (new_balance-starting_balance).toString() + " sats");
      payment_notification.textContent = "Net balance of " + (new_balance-starting_balance).toString() + " sats received!";
      


      if (ux_mode=="wait_invoice"){
        // alert("Invoice Paid!");
        document.body.style.backgroundColor = "#173627";
        img_qr_display_pic.src ="/img/green-check.png";
        
        payment_notification.textContent = "Invoice Paid!";
        clearRequestPaymentFields();
        
        ux_mode="init";
      }      

     
  }
  else if (new_balance < starting_balance)
  {
    payment_notification.textContent = "Net balance of " + (starting_balance - new_balance).toString() + " sats sent!";
    
  }
  else
  {
    payment_notification.textContent = "Ready for Payment!" ;
    document.body.style.backgroundColor = "#101820";
  }
  if (ux_mode == "init") {
        
      //do a check here so it doesn't load the image everytime    
      img_qr_display_pic.src = "/safebox/qr/{{lnurl}}";

              
      } 
  
  heading_balance.textContent = "(\u20BF" + Number(new_balance).toLocaleString("en-US") + ")";
  starting_balance = new_balance;

  //alert(JSON.stringify(balance));
}




// setInterval(pollPayment, 10000);



function pollPayment() {
var data; 


fetch('/safebox/poll')
    .then((response) => response.json())
    .then((data) => checkBalance(data['balance']));

// alert("hello");

}


function setActions(local_action_mode,local_action_data) {
  if (local_action_mode=="lnaddress"){
     
      
    
      const input_1 = document.getElementById("ln_recipient_address");
      const pay_1 = document.getElementById("ln_pay_button")
      input_1.value = local_action_data;
      pay_1.textContent = "Authorize Payment";
      //alert(local_action_mode  + local_action_data);
     
  }
  if (local_action_mode=="lninvoice"){
      const invoicePanel = document.getElementById("invoice_pay_panel");
      const invoiceInput = document.getElementById("ln_invoice_input");
      const invoiceSummary = document.getElementById("ln_invoice_summary");
      if (invoicePanel && invoiceInput) {
        invoicePanel.style.display = "block";
        invoiceInput.value = local_action_data || "";
        const summaryParts = [];
        if (action_amount) summaryParts.push(`${Number(action_amount).toLocaleString("en-US")} sats`);
        if (action_comment) summaryParts.push(action_comment);
        invoiceSummary.textContent = summaryParts.length ? `Invoice details: ${summaryParts.join(" | ")}` : "";
        userMessage("Invoice loaded. Review and authorize payment.", "INFO");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
  }
  if ((local_action_mode || "").length > 0 && window.history && window.history.replaceState) {
      window.history.replaceState({}, "", "/safebox/access");
  }
}

function getlnPayStatus(ln_pay_status) {
  // var ln_pay_button = document.getElementById("ln_pay_button");
    console.log(ln_pay_status);

    const parsedObject = JSON.parse(JSON.stringify(ln_pay_status));
    const status = parsedObject.status || "INFO";
    const detail = parsedObject.detail || "Payment request completed.";
    userMessage(detail, status);
    if (status === "OK") {
      userMessage("Payment accepted. Waiting for confirmation...", "INFO");
    }

    // location.reload();
  

}

async function lnPayAddress() {
  const recipient_address = document.getElementById("ln_recipient_address");
  const recipient_amount = document.getElementById("ln_recipient_amount");
  const recipient_memo = document.getElementById("ln_recipient_memo");
  const pay_button = document.getElementById("ln_pay_button");
  const ln_select_currency = document.getElementById("ln_select_currency");
  var ln_address = recipient_address.value;
  var ln_amount = recipient_amount.value;
  var ln_comment = recipient_memo.value;
  var ln_currency = ln_select_currency.value;
  // alert("Pay! " + ln_address + " " + ln_amount + " with comment "+ ln_comment);

  if (recipient_address.value == "NFC Tag") {
    //alert("Pay to NFC Tag");
    paytoNFC();
    return;
  }

  if (!confirm("Are you sure")) {
    return;

  }
  
  var old_text = pay_button.textContent;
  pay_button.textContent = "Paying now. Please wait...";
  pay_button.disabled = true;

  const submit_data = {"amount": ln_amount,
                        "address":ln_address, 
                        "currency" :ln_currency,
                        "comment": ln_comment};

    // alert(JSON.stringify(submit_data));
  console.log(submit_data);
    // ln_pay_button.textContent = "Please wait...";

      try {
        await fetch('/safebox/payaddress', {
              method: "POST",
              headers: {"Content-Type": "application/json"},        
              body: JSON.stringify(submit_data)         
            })
          .then((response) => response.json())
          .then((data) => getlnPayStatus(data));
      } catch (error) {
        userMessage("Payment request failed. Please try again.", "ERROR");
      } finally {
        pay_button.textContent = old_text;
        pay_button.disabled = false;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

}

async function lnPayInvoice() {
  // const recipient_address = document.getElementById("ln_recipient_address");
  // const recipient_amount = document.getElementById("ln_recipient_amount");
  const recipient_memo = document.getElementById("ln_invoice_memo");
  const invoice_input = document.getElementById("ln_invoice_input");
  const invoice_pay_button = document.getElementById("ln_invoice_pay_button");
  //var ln_address = recipient_address.value;
  //var ln_amount = parseInt(recipient_amount.value);
  var ln_comment = recipient_memo.value;
  // alert("Pay! " + ln_address + " " + ln_amount + " with comment "+ ln_comment);
  
  ln_invoice = (invoice_input?.value || "").trim();

  if (!ln_invoice) {
    userMessage("No lightning invoice loaded.", "ERROR");
    return;
  }

  // await alert("pay invoice " + ln_invoice);
  

  
  // console.log(ln_amount);

  const submit_data = {"invoice": ln_invoice,
                       "comment": ln_comment};


    const oldText = invoice_pay_button.textContent;
    invoice_pay_button.disabled = true;
    invoice_pay_button.textContent = "Please wait...";

    try {
      await fetch('/safebox/payinvoice', {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(submit_data)
      })
      .then((response) => response.json())
      .then((data) => getlnPayStatus(data));
    } finally {
      invoice_pay_button.textContent = oldText;
      invoice_pay_button.disabled = false;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
      


}



function getInvoiceStatus(ln_invoice_status) {
  // var ln_pay_button = document.getElementById("ln_pay_button");
    console.log(ln_invoice_status);

    var status = JSON.stringify(ln_invoice_status["detail"]);

    const parsedObject = JSON.parse(JSON.stringify(ln_invoice_status));
    alert("Payment " + parsedObject.detail);
  

}



</script>

<script>
  const ws_notify = new WebSocket("{{ws_url_notify}}");
  ws_notify.onopen = () => { console.log("WebSocket for notify connected for: {{ws_url_notify}} ");}
  ws_notify.onmessage = (event) => {
    console.log("Notification received:", event.data);
    const payload = JSON.parse(event.data);
    if (payload.action === "nfc_token") {
      const status = payload.status || "INFO";
      const detail = payload.detail || "NFC payment update";
      userMessage(detail, status);
      if (typeof payload.balance !== "undefined") {
        checkBalance(Number(payload.balance));
      }
      if (status === "OK") {
        clearRequestPaymentFields();
        document.getElementById("img_qr_display").src = "/img/green-check.png";
        setTimeout(() => {
          document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
        }, 2500);
        scheduleAccessReload(900);
      }
    }
    if (payload.action === "payment") {
      const status = payload.status || "INFO";
      const detail = payload.detail || "Payment update";
      userMessage(detail, status);
      if (typeof payload.balance !== "undefined") {
        checkBalance(Number(payload.balance));
      }
      if (typeof payload.fiat_balance !== "undefined") {
        document.getElementById("fiat_balance").innerText = `${payload.fiat_balance}`;
      }
      if (status === "SENT") {
        document.getElementById("img_qr_display").src = "/img/green-check.png";
        if (!reset_to_home_scheduled) {
          scheduleAccessReload(1200);
        }
      }
    }
  };
  ws_notify.onclose = () => { console.log("Notification closed");}
  

</script>

<script>
  document.addEventListener("touchstart", handleInteraction); 
  //document.addEventListener("click", handleInteraction); 
  const ws = new WebSocket("{{ws_url}}");

  ws.onopen = () => console.log("WebSocket connected for: {{ws_url}}");
  ws.onmessage = (event) => {
      console.log("Message received:", event.data);
      const response = JSON.parse(event.data);
      const balance = response.balance;
      const fiat_balance = response.fiat_balance;
      const message = response.message;
      const status = response.status
      userMessage(message, status)

      if (status == "RECD") {
        
        document.getElementById("heading_balance").innerText = `(\u20BF${Number(balance).toLocaleString("en-US")})`;
        document.getElementById("fiat_balance").innerText = `${fiat_balance}`;
        document.getElementById("payment_notification").innerText = `${message}`;
        if (ux_mode === "wait_invoice") {
          clearRequestPaymentFields();
          ux_mode = "init";
        }
        document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
        // document.getElementById("img_qr_display").removeEventListener("click", copyInvoicetoClipoboard);
        // document.getElementById("img_qr_display").addEventListener("click", copyAddress);
        // document.getElementById("ln_create_invoice_button").textContent = "Request Payment";
        document.getElementById("img_qr_display").src = "/img/green-check.png";
        setTimeout(() => {
                          // code to run after 5 seconds
                          console.log("5 seconds passed");
                          document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
                        }, 5000);
        scheduleAccessReload(900);
      
      } else if (status == "SENT" || status == "PENDING") {


      document.getElementById("fiat_balance").innerText = `${fiat_balance}`;
      document.getElementById("payment_notification").innerText = `${message}`;
      document.getElementById("img_qr_display").src = "/img/green-check.png";

             
      setTimeout(() => {
                          // code to run after 5 seconds
                          console.log("5 seconds passed");
                          document.getElementById("img_qr_display").src = "/safebox/qr/{{lnurl}}";
                        }, 5000);

      if (status == "SENT" && !reset_to_home_scheduled) {
        scheduleAccessReload(1200);
      }

      }


  };
  ws.onclose = () => console.log("WebSocket closed");

  async function sendMessage() {
      
      // ws.send("App is touched");
      alert("Coming soon!");
      
  }

  async function handleInteraction(event) {
    console.log("Interaction detected:", event.type, "on element:", event.target);
    // Add your custom logic here
    // sendMessage();
}
 

  
</script>

{% endblock %}

{% block page_content %}
<div class="center-text">

  <div class="account-box">
    <h1  id="fiat_balance" style="margin: 0;">{{currency_symbol}}{{"{:.2f}".format(currency_rate * acorn.balance / 1e8)}} {{currency_code}}</h1>
    <p id="heading_balance" style="margin: 0;">({{ "\u20BF" + "{:,}".format(acorn.balance)}})</p>
      <select class="balance-currency-selector" id="owner_select_currency" name="select_currency" onchange="setOwnerCurrency()">
        {% for entry in currencies %}
        <option value="{{entry}}" {% if entry == currency_code %}selected{% endif %}>{{entry}}</option>         
        {% endfor %}
    </select>
    <br>

    <span id="payment_notification">
      {{ action_comment if action_comment else ""}}
    </span>  
    
    {% if onboard == true %}
    Welcome! Please see the <a href="#fine-print">fine print</a> below.
    <br><br>
    {% endif %}
    <button id="ln_scan_button" onclick="scanCode()">Scan</button>
    <br>
    <button id="ln_clipboard_button" onclick="useClipboard()">Copy from Clipboard</button>
    <br>
  </div>

    <div class="account-box">
      <h2 style="margin: 0;">Request a Payment</h2>
      <img id="img_qr_display"  src="/safebox/qr/{{lnurl}}">
      <h3 id="ln_address_text" onclick="copyAddress()"><b>{{lightning_address}}</b></h3>
      <input type="number" inputmode="decimal" step="any" placeholder="enter  amount" id="ln_create_invoice_amount" name="ln_create_invoice_amount" size="24">      
    <select id="ln_select_invoice_currency" name="ln_select_invoice_currency"> 
      <option value="SAT" {% if currency == "SAT" %}selected{% endif %}>SAT</option>            
      {% for each in currencies %}     
       <option value="{{each}}" {% if currency == each %}selected{% endif %}>{{each}}</option>        
      {% endfor %}
    </select>   
      <textarea id="ln_request_memo" placeholder= "Enter optional comment" name="txt_comment" rows="3" cols="24"></textarea>
      <!-- New checkbox for NFC payment -->
      <label>
      <input type="checkbox" id="nfc_payment_checkbox" name="nfc_payment_checkbox">
      Request by NFC
      </label>
      <pre id="log"></pre>
      <button id="ln_create_invoice_button" onclick="requestPayment()">Request Payment</button>
    </div>

    <div class="account-box">
      <h2 style="margin: 0;">Make a Payment</h2>
      <div id="invoice_pay_panel" style="display:none;">
        <h3 style="margin:0 0 8px;">Pay Scanned Invoice</h3>
        <input type="text" id="ln_invoice_input" placeholder="Lightning invoice" autocomplete="off">
        <p id="ln_invoice_summary" style="margin: 6px 0 0;"></p>
        <textarea id="ln_invoice_memo" placeholder="Enter optional comment" name="txt_invoice_comment" rows="3" cols="24"></textarea>
        <button id="ln_invoice_pay_button" onclick="lnPayInvoice()">Authorize Invoice Payment</button>
      </div>
      <input type="text" list= "contacts" placeholder="enter recipient address"  id="ln_recipient_address" name="ln_recipient_address"  size="32" ">
      <datalist id="contacts">
                <option value="NFC Tag"></option>
               
      </datalist>
      <br>
     
      <br><input type="number" inputmode="decimal" step="any" placeholder="enter amount" id="ln_recipient_amount" name="ln_recipient_amount"   size="8">
      
      <select id="ln_select_currency" name="ln_select_currency"> 
        <option value="SAT" >SAT</option>            
        {% for each in currencies %}     
         <option value="{{each}}" {% if each == currency %}selected{% endif %}>{{each}}</option>        
        {% endfor %}
      </select>
      <br>
      
      <textarea id="ln_recipient_memo" placeholder= "enter memo or comment" name="txt_comment" rows="3" cols="24"></textarea>
      <br>
      <button id="ln_pay_button" onclick="lnPayAddress()">Pay to Recipient</button> 
      <br>

    <div class="btn-stack">
      <button id="my_ecash_button" onclick="myEcash()">Pay with Ecash</button>
      <button onclick="doAccountHistory()">Account History</button>
    </div>
    <pre id="pay_to_message">Ready.</pre>
  </div>
  

  <div class="account-box">
    <h2>My Records</h2>
    <div class="btn-stack">
      <button id="my_personal_messages_button" onclick="personalMessages()">Private Messages</button>
      <button id="my_private_data_button" onclick="privateData()">My Notes</button>
      <button id="my_personal_records_button" onclick="myRecords()">My Records</button>
    </div>
  </div>

  
  <div class="account-box">
    <h2>Community</h2>
    <div class="btn-stack">
      <button id="do_issue_credential" onclick="doOfferRecord()">Offer Record</button>
      <button id="my_credentials_button" onclick="requestRecord()">Request a Record</button>
      <button id="onboard_button" onclick="onboardFriend()">Onboard a Member</button>
    </div>
  </div>



  

  <br>
  <div class="account-box">
  
 
    <h2> Reusable Payment Request </h2> 
  
    <form fx-action="/safebox/requestqr" 
        fx-method="get" 
        fx-target="#request_qr" 
        fx-swap="innerHTML" 
        >
        <label for="amount">Amount:</label>
      <input 
        type="number" 
        inputmode="decimal"
        id="amount" 
        name="amount" 
        step="any" 
        min="0" 
        required
        >
        <select id="request_select_currency" name="select_currency">
          <option >SAT</option> 
          {% for entry in currencies %}
          <option >{{entry}}</option>         
          {% endfor %}
        </select>
        <br><br>
        <label for="desc">Description:</label>
        <input 
          type="text" 
          id="description" 
          name="description" 
          maxlength="25" 
          placeholder="Enter text (optional)"
        >
        <br><br>

        <button type="submit">Generate Payment Request</button></form>
    <br>   
  
    <div id="request_qr" class="request-qr-output"></div>
        

    

  
  
  </div>
  <div class="account-box">
    <h2>My Account</h2>
    <p>My access_key: </b></p>
    <p id="access_key_reveal_text" onclick="revealAccessKey()">*********</p>   
    <p>My recovery phrase: <br> 
    <p id="seed_phrase_reveal_text" onclick="revealSeedPhrase()">*********</p>
    
    
    <div class="btn-stack">
      <button id="clipboard_button" onclick="copytoClipboard()">Backup</button>
      <button id="issue_card" onclick="issueCard()">Issue Card</button>
      <button onclick="attest()">Attest</button>
      <button onclick="trust()">Trust</button>
      <button id="logout_button" onclick="logout()">Logout</button>
    </div>
  </div>
  <br>
 
 {% if onboard == true %}
 <h2 id="fine-print" >The Fine Print</h2>
 <h3>Welcome to {{branding}}! </h3>
 <p>You are automatically and securely logged in! Write down your access key as soon as you can. You can find your access key and recovery phrase above. By continuing, you have agreed to the terms and conditions of this awesome experimental service! </p>
 {% endif %}

  <div class="account-box">
    <h2>Technical Info</h2>

    <br>npub: {{acorn.pubkey_bech32[:10]}}...{{acorn.pubkey_bech32[-8:]}}
    <pre id="npub"onclick="copyNpub()">{{acorn.pubkey_bech32[:10]}}...{{acorn.pubkey_bech32[-8:]}}</pre>
    <br>pubhex: {{acorn.pubkey_hex[:10]}}...{{acorn.pubkey_hex[-8:]}}
    <br>owner: {{acorn.owner[:10]}}...{{acorn.owner[-8:]}}
    <br>home relay: {{acorn.home_relay}}
    <br><br>
    <a href="/public/rates">Exchange Rates</a>
    <br><br>
    <button id="point_of_sale" onclick="window.location.href='/pos/'">Point of Sale</button>
    <br><br>
    <button id="danger_zone"onclick="dangerZone()" >Danger Zone!</button>
    
    <br><br>
    
    
    
    <br><br><a href="https://github.com/trbouma/safebox">Source Code</a>
  </div>


            
</div>

<script>
setActions(action_mode,action_data);
setDarkMode();



</script>

{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}
